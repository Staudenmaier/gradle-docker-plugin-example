import de.gesellix.gradle.docker.tasks.DockerBuildTask
import de.gesellix.gradle.docker.tasks.DockerPsTask
import de.gesellix.gradle.docker.tasks.DockerPullTask
import de.gesellix.gradle.docker.tasks.DockerPushTask

import static groovy.json.JsonOutput.prettyPrint
import static groovy.json.JsonOutput.toJson

buildscript {
  repositories {
    mavenLocal()
    maven { url 'http://dl.bintray.com/gesellix/docker-utils' }
    mavenCentral()
  }

  dependencies {
    classpath 'de.gesellix:gradle-docker-plugin:2014-07-05T19-53-25'
  }
}

apply plugin: 'docker'
apply plugin: 'groovy'

repositories {
  mavenLocal()
  maven { url 'http://dl.bintray.com/gesellix/docker-utils' }
  mavenCentral()
}

docker {
  dockerHost = "http://172.17.42.1:4243/"
  authConfigPlain = ["username"     : "gesellix",
                     "password"     : "-yet-another-password-",
                     "email"        : "tobias@gesellix.de",
                     "serveraddress": "https://index.docker.io/v1/"]
}

task buildImage(type: DockerBuildTask) {
  imageName = "gesellix/example"
  buildContextDirectory = file('./docker/')
}

task pushImage(type: DockerPushTask) {
  dependsOn buildImage

  repositoryName = "gesellix/example"
  registry = "localhost:5000"
}

task pullImageOnRemoteServer(type: DockerPullTask) {
  dependsOn pushImage

  dockerHost = "http://172.17.42.1:4243/"
  imageName = "gesellix/example"
  registry = "localhost:5000"
}

//task stopContainerOnRemoteServer(type: DockerStopTask) {
//  dockerHost = "http://172.17.42.1:4243/"
//  containerId = "foo"
//}

//task rmContainerOnRemoteServer(type: DockerRmTask) {
//  dockerHost = "http://172.17.42.1:4243/"
//  containerId = "foo"
//}

//task runContainerOnRemoteServer(type: DockerRunTask) {
//  dockerHost = "http://172.17.42.1:4243/"
//  imageName = "foo"
//  containerName = "bar"
//  containerConfiguration = ["ExposedPorts": ["8889/tcp": {}, "9300/tcp": {}]]
//  // todo configure portmapping
//}

task listContainersOnRemoteServer(type: DockerPsTask) {
  dockerHost = "http://172.17.42.1:4243/"

  doLast {
    println prettyPrint(toJson(containers))
  }
}

task wrapper(type: Wrapper) {
  gradleVersion = '2.0'
  distributionUrl = "http://services.gradle.org/distributions/gradle-${gradleVersion}-all.zip"
}
