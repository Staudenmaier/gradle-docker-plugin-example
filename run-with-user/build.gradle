import de.gesellix.gradle.docker.tasks.DockerBuildTask
import de.gesellix.gradle.docker.tasks.DockerRmTask
import de.gesellix.gradle.docker.tasks.DockerRmiTask
import de.gesellix.gradle.docker.tasks.DockerRunTask
import de.gesellix.gradle.docker.tasks.DockerStopTask
import de.gesellix.gradle.docker.tasks.GenericDockerTask
import de.gesellix.util.IOUtils

task rmImage(type: DockerRmiTask) {
  imageId = "run-with-user"
}

task buildImage(type: DockerBuildTask) {
  dependsOn rmImage
  imageName = "run-with-user"
  buildContextDirectory = file("./docker/")
}

task stopContainer(type: DockerStopTask) {
  dependsOn buildImage
  containerId = "run-with-user-example"
}

task rmContainer(type: DockerRmTask) {
  dependsOn stopContainer
  containerId = "run-with-user-example"
}

task runContainer(type: DockerRunTask) {
  dependsOn rmContainer
  imageName = "run-with-user"
  containerName = "run-with-user-example"
  containerConfiguration = [Tty: true]
  containerConfiguration.User = "root"
}

task printContainerLogs(type: GenericDockerTask) {
  dependsOn runContainer

  doLast {
    def response = getDockerClient().logs("run-with-user-example")
    logger.lifecycle IOUtils.toString(response.stream as InputStream)
  }
}
